{% extends 'base.html' %}

{% block content %}
<div style="position:fixed; height:100%;width:100%; display:block;">
    <div style="position:fixed; height:60px; width:100%;"
        class="d-flex justify-content-between align-items-center bg-light shadow-sm">
        <div class="d-flex align-items-center">
            <a href="/?floor={{data.table.flr|urlencode}}" class="fw-bold ms-1 me-3 btn btn-light fs-4"><i
                    class="bi bi-arrow-left"></i></a>
            <div class="fs-4 fw-bold text-dark text-capitalize" id="tablename" data-table="{{data.table.clientname}}"
                data-client="{{data.table.client}}">Table: {{data.table.clientname}}</div>
        </div>
        <div>
            <input name="search" class="form-control" id="search" placeholder="Type to search...">
        </div>
        <div>
            <button type="button" data-table="{{data.table.clientname}}" id="accept-order"
                class="btn btn-success mx-2">Accept Order</button>
        </div>
    </div>
    <div style="position:fixed; margin-top:60px; height:calc(100% - 60px);width:30%;">
        <div style="height:100%; position:relative;">
            <div class="d-flex bg-dark text-white" style="position:absolute; width:100%; top:0; height:30px;">
                <div class="text-uppercase" style="width:50%; padding:3px;">Item</div>
                <div class="text-uppercase text-end" style="width:15%; padding:3px;">Qty</div>
                <div class="text-uppercase text-end" style="width:35%; padding:3px;">Amount</div>
                <!-- <div  style="width:10%;">&nbsp;</div> -->
            </div>
            <div style="position:absolute; top:30px; width:100%; height:calc(100% - 120px); overflow:auto;" id="orders-container">
                <table id="orders-table" style="width:100%;">
                    {# <tbody id="newOrdersTable"></tbody> #}
                </table>
            </div>
            <div style="position:absolute; width:100%; bottom:0; height:80px;">
                <div class="d-flex align-items-center mb-2 justify-content-between px-1">
                    <button type="button" class="flex-fill btn btn-secondary text-button-label fw-bold" id="qty-plus"
                        style="font-size:18px;" disabled><i class="bi bi-plus-circle-fill text-white"></i></button>
                    <button type="button" class="flex-fill btn btn-secondary text-button-label fw-bold mx-1"
                        id="qty-minus" style="font-size:18px" disabled><i
                            class="bi bi-dash-circle-fill text-white"></i></button>
                    <button type="button" class="flex-fill btn btn-secondary text-button-label fw-bold modal-toggle"
                        id="settings" data-type="settings" style="font-size:18px" disabled><i
                            class="bi bi-info-circle-fill text-white"></i></button>
                </div>
                <div class="d-flex px-1 justify-content-between bg-dark text-white">
                    <strong class="text-uppercase" style="padding: 5px 5px;">Total</strong>
                    <strong style="padding:5px 0 5px 5px;" id="orders-total"></strong>
                </div>
            </div>
        </div>
    </div>
    <div style="position:fixed; margin-top:60px; margin-left:30%; height:calc(100% - 60px); width:calc(100% - 30%);"
        class="d-flex">
        <div id="modal-holder" style="height:100%; width:calc(100% - 100px); position:relative;">
            <div id="products-container" style="height:100%; overflow:auto; padding:5px;">
                <div id="products" style="flex:1 1 auto; min-height:1px;">
                </div>
            </div>
            <div id="sub-products-container" style="height:0%; overflow:auto; padding:5px; border-top:1px solid gray;">
                <div id="sub-products" style="flex:1 1 auto; min-height:1px;">
                </div>
            </div>
            <div id="group-modal" class="modal right" role="dialog">
                <div class="modal-dialog">
                    <!-- Modal content-->
                    <div class="modal-content border-0 rounded-0">
                        <div class="modal-header">
                            <h4 class="modal-title"></h4>
                            <button type="button" class="close btn btn-danger rounded-circle"
                                data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div style="height:100%; width:100px; overflow:auto;" class="bg-light">
            {%for category in data.categories%}
                <div style="padding:5px;">
                    <div type="button" data-category="{{category.name}}"
                        style="text-decoration:none; width:100%; border-radius:5px; padding: 5px; text-align:center; overflow:visible; display:block;"
                        class="text-white bg-secondary text-button-label category">{{category.name}}</div>
                </div>
            {%endfor%}
        </div>

    </div>

    {# <div style="position:absolute;width:300px;left:30%;top:60px;border: 1px solid #aaa;" class="bg-light text-center"
        id="remarksModal">
        <div class="p-4 w-100" style="position:relative;">
            <button id="closeRemarks" class="btn btn-danger text-white"
                style="position:absolute;right:10px;top:10px">X</button>
            <div class="fw-bold mb-3" id="remarkProduct"></div>
            <div class="mb-4"><input name="remarks" id="remarkInput" placeholder="Add remarks"></div>
            <div id="remarkOptions"></div>
        </div>
    </div> #}

</div>

{% endblock %}
{% block js %}
<script type="text/javascript">
    var markedBg = '#4788ff';
    var markedColor = '#fff';

    function throttle(f, delay) {
        var timer = null;
        return function () {
            var context = this, args = arguments;
            clearTimeout(timer);
            timer = window.setTimeout(function () {
                f.apply(context, args);
            },
                delay || 500);
        };
    }
    function Orders(){
        this.loaded = false;
        this.orders = [];
        this.local = [];
        this.active = [];
        this.total = 0;
        this.getLocalOrders = function(){
            var localOrders = window.localStorage.getItem('orders')
            if(!localOrders) local = []
            else local = JSON.parse(localOrders)

            return local
        } 
        this.putLocalOrders = function(barcode, name, qty, price){
            let local = this.getLocalOrders() || []
            let found = -1;
            for(let i in local){
                if(local[i]['barcode'] == barcode) found = i
            }
            if(found > -1){
                local[found]['qty'] = local[found]['qty'] + qty;
                local[found]['amount'] = parseFloat(local[found]['qty']) * parseFloat(price)
                local[found]['selected'] = true
            }else{
                local.push({
                    barcode: barcode,
                    name: name,
                    qty: qty,
                    remarks: '',
                    group: 'A',
                    amount: parseFloat(qty) * parseFloat(price),
                    selected: true
                })
            }
            window.localStorage.setItem('orders', JSON.stringify(local))
            this.display(false)
            this.listActive()
        }
        this.getOrders = async function(f=true){
            this.local = []
            this.total = 0;
            if(f){
                let client = $('#tablename').data('client');
                const response = await fetch('/orders?client=' + client);
                this.orders = await response.json()
                if(!this.orders) this.orders = []
            }
            for(let i in this.orders){
                this.total += parseFloat(this.orders[i]['amount'])
                this.local.push(this.orders[i])
            }
            let local = this.getLocalOrders()
            local.forEach(row => {
                this.total += parseFloat(row.amount)
                this.local.push({
                    id: 0,
                    barcode: row.barcode,
                    name: row.name,
                    qty: row.qty,
                    amount: row.amount,
                    remarks: row.remarks,
                    printed: false,
                    group: row.group,
                    senior: "",
                });
            });
            this.loaded = true;
        }
        this.listActive = function(){
            let self = this
            this.active = []
            $('#orders-table').find('tr').each(function(){
                if($(this).hasClass('selected')) self.active.push($(this).data('index'));
            });
            if(this.active.length > 0){
                $('#qty-plus, #qty-minus, #settings').prop('disabled', false);
            }else{
                $('#qty-plus, #qty-minus, #settings').prop('disabled', true);
                $("#group-modal").modal("hide");
            }
        }
        this.makeActive = function(index, reset=false){
            $('#orders-table').find('tr').each(function(){
                if(reset) $(this).removeClass('active')
                if(index == $(this).data('index')) $(this).addClass('active')
            });
        }
        this.tdClicked = function(t){
            let i = $(t).closest('tr').data('index');
            if(this.active.indexOf(i) > -1){
                $(t).closest('tr').removeClass('alert-primary')
                if($(t).closest('tr').data('id') > 0) $(t).closest('tr').addClass('alert-success');
                else $(t).closest('tr').addClass('alert-warning'); 
                $(t).closest('tr').removeClass('selected');
            }else{
                $(t).closest('tr').removeClass('alert-warning alert-success').addClass('alert-primary');
                $(t).closest('tr').addClass('selected');
            }
            this.listActive();
        }
        this.display = async function(f=true){
            await this.getOrders(f)
            let tbody = $('<tbody />');
            this.local.forEach((item, i) => {
                let self = this
                let tr = $('<tr />')
                    .attr('data-index', i)
                    .attr('data-id', item.id)
                    .attr('data-client', item.client)
                    .attr('data-barcode', item.barcode)
                    .css('cursor','pointer');
                if(item.id > 0) tr.addClass('alert alert-success');
                else tr.addClass('alert alert-warning');

                let name = $('<td />').css({
                    width: 'calc(50% - 30px)',
                    padding: '3px'
                }).click(function(){
                    self.tdClicked(this)
                }).append(
                    $('<div class="item-name small fw-bold" />').html(item.name),
                    $('<div class="text-danger small item-remarks" />').append(
                        $('<span />').addClass('badge bg-primary me-2').html(item.group),
                        $('<span />').addClass('badge bg-danger me-2').html(item.remarks),
                        ))

                let qty = $('<td />').css({
                    width: '15%',
                    padding: '3px'
                }).click(function(){
                    self.tdClicked(this)
                }).addClass('text-end item-qty small').html(parseInt(item.qty))
                
                let amount = $('<td />').css({
                    width: '35%',
                    padding: '3px'
                }).click(function(){
                    self.tdClicked(this)
                }).addClass('text-end item-price small fw-bold').html(parseFloat(item.amount).toFixed(2));

                tr.append(name).append(qty).append(amount).appendTo(tbody);

            });

            $('#orders-table').html(tbody)
            $('#orders-total').html(this.total.toFixed(2))

            if(!f){
                $("#orders-container").animate({ scrollTop: $('#orders-container').prop("scrollHeight") }, 1000);
            }

        }
    }

    function products(path) {
        console.log('o', o);
        $.get(path).then(function (response) {

            if (response.subProducts.length > 0) {
                $('#products-container').css({ height: '50%' });
                $('#sub-products-container').css({ height: '50%' });
            } else {
                $('#products-container').css({ height: '100%' });
                $('#sub-products-container').css({ height: '0%' });
            }
            let p = $('<div />').addClass('products').css({
                flex: "1 1 auto",
                minHeight: "1px"
            });
            response.products.forEach(product => {
                let box = $('<div />').addClass('box mb-2 product');
                if(product.barcode > ''){
                    box.addClass('can-order')
                    box.click(function(){
                        o.putLocalOrders(product.barcode, product.itemname, 1, product.amt);
                    })
                }else{
                    box.addClass('has-group')
                }
                box.attr('data-category', product.class).attr('data-group', product.itemname)
                $('<button />').attr('type', 'button').addClass('btn btn-light w-100 h-100 text-button-label').html(product.itemname).appendTo(box);
                box.appendTo(p);
            });
            $('#products-container').html(p);

            let sp = $('<div />').addClass('sub-products').css({
                flex: "1 1 auto",
                minHeight: "1px"
            });
            response.subProducts.forEach(subProduct => {
                let box = $('<div />').addClass('box mb-2 sub-product can-order').click(function(){
                    o.putLocalOrders(subProduct.barcode, subProduct.itemname, 1, subProduct.amt);
                });
                $('<button />').attr('type', 'button').addClass('btn btn-light w-100 h-100 text-button-label').html(subProduct.itemname).appendTo(box);
                box.appendTo(sp);
            });
            $('#sub-products-container').html(sp)
        });
    }

    var o = new Orders()
    $(document).ready(function () {
        $("body").on("click", ".modal-toggle", function () {
            $("#group-modal").modal("show");
            $("#modal-holder").addClass("after_modal_appended");
            //appending modal background inside the blue div
            $('.modal-backdrop').appendTo('#modal-holder');
            //remove the padding right and modal-open class from the body tag which bootstrap adds when a modal is shown
            $('body').removeClass("modal-open")
            $('body').css("padding-right", "");
        });
        $('.modal').on('click', '.close', function () {
            $("#group-modal").modal("hide");
        });

        o.display();

    });
    $(document).on('click', '.category', function () {
        products('/products?category=' + $(this).data('category'));
    });

    $(document).on('click', '.group', function () {
        products('/products?category=' + $(this).data('category') + '&group=' + $(this).data('group'));
    });

    /* setup before functions */
    var typingTimer;                /* timer identifier */
    var doneTypingInterval = 800;  /* time in ms, 5 second for example */
    var $input = $(document).find('#search');

    $(document).on('keyup', '#search', function (e) {
        if (e.keyCode == 13){
            $(this).blur();
            doneTyping()
        }else{
            clearTimeout(typingTimer);
            typingTimer = setTimeout(doneTyping, doneTypingInterval);
        }
    });

    $(document).on('keydown', '#search', function () {
        clearTimeout(typingTimer);
    });
    
    $(document).on('focusout', '#search', function(){ $(this).blur()})

    function doneTyping () {
        let code = $('#search').val();
        if (code.length > 0) {
            products('/products?search=' + code);
        }
    }

</script>

{% endblock %}