{% extends 'base.html' %}
{% block content %}
<div class="vh-100" id="observer-wrapper" style="background:#34495e; overflow:auto;">
</div>
{% endblock %}
{% block js %}
<script src="{{ url_for('static', filename= 'js/socket.io.js') }}"></script>
<script src="{{ url_for('static', filename= 'js/masonry.min.js') }}"></script>
<script type="text/javascript">
    var socket = io();
    function Observe(){
        this.kitchens = []
        this.getObserve = function(){
            let observer = window.localStorage.getItem('observer')
            if(!observer) this.kitchens = []
            else this.kitchens = JSON.parse(observer)
        }
        this.setObserve = function (){
            window.localStorage.setItem('observer', JSON.stringify(this.kitchens));
            document.location.reload();
        }
        this.selectKitchen = function(){
            let self = this
            $.get('/kitchens').then(function(response){
                let card = $('<div />').addClass('w-25 shadow-sm card border-0 mx-auto');
                let cardBody = $('<div />').addClass('card-body p-5');
                if(response.length){
                    response.forEach((row, i) => {
                        let id = 'btn-check-'+i;
                        $('<div />').append(
                            $('<input />').attr('type', 'checkbox').addClass('btn-check').attr('id', id).attr('autocomplete', 'off').change(function(){
                                if($(this).is(':checked')){
                                    if(!self.kitchens.includes(row.printer)){
                                        self.kitchens.push(row.printer)
                                    }
                                }else{
                                    const index = self.kitchens.indexOf(row.printer)
                                    self.kitchens.splice(index, 1);
                                }
                            }),
                            $('<label />').addClass('btn btn-outline-success w-100 mb-2').attr('for', id).html(row.printer)
                        ).appendTo(cardBody);
                    });
                }
                let cardFooter = $('<div />').addClass('card-footer text-center bg-white border-0 p-5');
                $('<button />').attr('type', 'button').addClass('btn btn-primary').click(function(){
                    $(this).prop('disabled', true).html('Getting Orders...');
                    self.setObserve();
                }).html('Start Observing').appendTo(cardFooter);
                $('<div />').addClass('card-header border-0 text-center text-uppercase bg-primary text-white fs-5').html('Observe Orders From').appendTo(card)
                cardBody.appendTo(card)
                cardFooter.appendTo(card)

                $('#observer-wrapper').css('padding', '30px 0').html(card);
            });
        }

        this.table = function(key, object){
            let self = this;

            if(!$('#table-'+key).length){
                card = $('<div />').addClass('card m-1 border-0 shadow-sm').attr('id', 'table-'+key);
                $('<div />').addClass('card-header border-0 bg-primary text-white fs-6 fw-bold text-start text-uppercase').append(object.name).appendTo(card);
                $('<div />').addClass('card-body p-0').appendTo(card);
                $('<div />').css({float:'left', width:'250px'}).addClass('mb-2').html(card).appendTo($('#tables-wrapper'));
            }
            $('#table-'+key).find('.card-body').html('');
            if(!object.items.length) return false;

            let duration = null;
            let groupings = {};
            object.items.forEach((item) => {
                let row = $('<div />').attr('id', 'id-'+item.id).css('margin', '1px');
                let pending = $('<a />').attr('type', 'button').addClass('text-decoration-none shadow-sm rounded-1 p-2 d-block bg-white');
                $('<div />').addClass('fw-bold text-uppercase text-dark').css('font-size', '14px').html(item.name).appendTo(pending);
                if(item.group != 'A') $('<div />').addClass('small text-secondary').css('font-size', '12px').html('- Group '+item.group).appendTo(pending);
                if(item.remarks > '') $('<div class="small text-danger" />').html('- '+item.remarks).appendTo(pending);

                let served = $('<div />').addClass('rounded shadow-sm p-1 served d-block').css('background','#e8e8e8');
                let g = item.group != 'A' ? '<i>('+item.group+')</i>':''
                $('<div />').addClass('fw-bold text-uppercase').css('font-size', '13px').html('<s>'+item.name+g+'</s>').appendTo(served)
                $('<div />').addClass('small text-secondary').css('font-size', '12px').html('- Served '+(item.served > 0 ? item.served + 'm': 'just now')).appendTo(served);
                if(item.remarks > ''){
                    $('<div class="small text-danger" />').css('font-size', '12px').html('- '+item.remarks).appendTo(served);
                }
                if(item.served == null){
                    served.removeClass('d-block').addClass('d-none');
                    pending.removeClass('d-none').addClass('d-block');
                }else{
                    served.removeClass('d-none').addClass('d-block');
                    pending.removeClass('d-block').addClass('d-none');
                }
                pending.click(function(){
                    if(confirm(`Serve ${item.name} for table ${item.table}?`)){
                        $.post('/order/serve', {id:item.id}).done(function(){
                            socket.emit('refresh', item.client, self.kitchens)
                        });
                    }
                });

                row.append(pending);
                row.append(served);
                if(duration != item.duration){
                    duration = item.duration;
                    groupings[duration] = []
                }
                groupings[duration].push(row);
            });
            for (const duration in groupings) {
                let rows = groupings[duration];
                let color = '#27ae60';
                if(duration > 20) color = '#e67e22';
                if(duration > 30) color = '#c0392b';
                let gwrapper = $('<div />').addClass('rounded-1 mx-1 my-1').css({background: color+'44'}).css({padding: '1px'})
                gwrapper.append(
                    $('<p />').addClass('fw-bold mb-0 mt-2 text-end px-2').css({fontSize:'12px', 'color': color}).html(
                        $('<span />').html(duration > 0 ? duration+'m':'now')
                    )
                );
                rows.forEach(row => {
                    gwrapper.append(row);
                })
                $('#table-'+key).find('.card-body').append(gwrapper);
            }
        }

        this.display = function(response){
            $('#observer-wrapper').html($('<div />').attr('data-masonry', '{"percentPosition": true}').attr('id', 'tables-wrapper'));
            for(key in response){
                let items = response[key]
                this.table(key, items)
            }
        }
    }
    var observe = new Observe()
    $(document).ready(function(){
        observe.getObserve()
        if(observe.kitchens.length > 0){
            socket.on('connect', function() {
                socket.emit('read', observe.kitchens);
            }); 
            socket.on('observe', function(response){
                observe.display(response);
            });
            socket.on('refreshed', function(response){
                let key = Object.keys(response)[0]
                let obj = response[key];
                observe.table(key, obj);
            });
        }else{
            observe.selectKitchen()
        }
    });
</script>
{% endblock %}